---
interface Streamer {
  url: string;
  name: string;
  channelId: string;
}

interface Props {
  text: string;
  streamers: Streamer[];
  availableChannels: Set<string>
}

const { text } = Astro.props;
const componentId = text.replace(/\s/g, "-").toLowerCase();

const scriptVars = { componentId };
---

<>
  <div class="relative">
    <button
      id={`menu-toggle-${componentId}`}
      aria-controls={`sublist-${componentId}`}
      type="button"
      class:list={[
        "flex items-center w-full text-left",
        "px-6 py-3 rounded-r-lg",
        "bg-bg-tertiary",
        "border-border-subtle border border-l-0",
        "font-semibold -ml-4",
        "justify-between",
        "cursor-pointer",
      ]}
    >
      <span class="pl-0">
        {text}
      </span>

      <svg
        class="w-5 h-5 text-text-primary [.is-expanded_&]:rotate-180"        
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 20 20"
        fill="currentColor"
      >
        <path
          fill-rule="evenodd"
          d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z"
          clip-rule="evenodd"></path>
      </svg>
    </button>
  </div>

  <ul
    id={`sublist-${componentId}`}
    role="menu"
    class=""
    aria-labelledby={`menu-toggle-${componentId}`}
  >
    {
      Astro.props.streamers.map((streamer) => {
        const isAvailable = Astro.props.availableChannels.has(streamer.channelId);

        const baseClasses = [
          "block py-2 text-sm pl-4 pr-4 border-l-4 font-medium",
        ];
        
        const activeClasses = [
          ...baseClasses,
          "text-text-primary hover:border-l-accent-nav-item-active",
        ];

        const inactiveClasses = [
          ...baseClasses,
          "text-gray-500 cursor-not-allowed",
          "pointer-events-none",
        ];

        return (
          <li role="none">
            {isAvailable ? (
              <a
                href={streamer.url}
                role="menuitem"
                class:list={activeClasses}
              >
                {streamer.name}
              </a>
            ) : (
              <span 
                role="menuitem"
                aria-disabled="true"
                class:list={inactiveClasses}
              >
                {streamer.name}
              </span>
            )}
          </li>
        );
      })
    }
  </ul>
</>
<script define:vars={scriptVars}>
  const button = document.getElementById(`menu-toggle-${componentId}`);
  const sublist = document.getElementById(`sublist-${componentId}`);

  if (button && sublist) {
    sublist.style.display = "none";
    button.setAttribute("aria-expanded", "false");
    button.classList.remove("is-expanded");

    button.addEventListener("click", () => {
      const isExpanded = button.getAttribute("aria-expanded") === "true";

      if (isExpanded) {
        sublist.style.display = "none";
        button.setAttribute("aria-expanded", "false");
        button.classList.remove("is-expanded");
      } else {
        sublist.style.display = "block";
        button.setAttribute("aria-expanded", "true");
        button.classList.add("is-expanded");
      }
    });
  }
</script>
