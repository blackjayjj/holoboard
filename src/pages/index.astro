---
import Welcome from "../components/Welcome.astro";
import Card from "../components/Card.astro";
import Layout from "../layouts/Layout.astro";
import {
  getVideos,
  getDailyYenAmount,
  getYenByName,
  getTopVideos,
  getTopChannels,
  getRecentVideos,
  getSuperchatCount,
  getUniqueVideoCount,
} from "../lib/supabase";
import { channelIdToNameMap } from "../lib/streamers";
import SummaryTable from "../components/SummaryTable.astro";
import TopDonors from "../components/TopDonors.astro";
import TabVideo from "../components/TabVideo.astro";
import { yenFormatter, formatNumberCompact } from "../lib/formatters";

// const data = await getDailyYenAmount();
// const chartLabels = data.map((row) => row.sale_date);
const plotlyXData = [
  "2025-10-20",
  "2025-10-21",
  "2025-10-22",
  "2025-10-23",
  "2025-10-24",
  "2025-10-25",
  "2025-10-26",
  "2025-10-27",
  "2025-10-28",
  "2025-10-29",
  "2025-10-30",
  "2025-10-31",
];
const plotlyYData = [
  1123831, 1290395, 948592, 1025866, 741710, 1383751, 1547230, 965507, 1160446,
  847568, 754110, 1267884,
];
// const yenByName = await getYenByName()
const yenByName = [
  { chat_name: "Sloth of Shadows", total_yen: 222870 },
  { chat_name: "@Generix90", total_yen: 212700 },
  { chat_name: "ãƒ‘ãƒ¼ã‚·ã‚¹", total_yen: 200098 },
  { chat_name: "ç„¡è‰²ã®è­¦å‚™ä¿‚", total_yen: 150000 },
  { chat_name: "MAIMAI", total_yen: 143510 },
  { chat_name: "zipli", total_yen: 119943 },
  { chat_name: "@dan_game_ch", total_yen: 110000 },
  { chat_name: "ãªã®", total_yen: 106750 },
  { chat_name: "Wrixne Lenti", total_yen: 104141 },
  { chat_name: "@musyoku_no", total_yen: 101000 },
];
// const topVideos = await getTopVideos();
const topVideos = [
  {
    video_id: "LbOsSfvDQhM",
    video_title:
      'ã€ é›‘è«‡/Freetalk ã€‘"SHINier"ãŠç–²ã‚Œæ§˜ï¼ï¼æœ¬å½“ã«ã‚ã‚ŠãŒã¨ã†ï¼ï¼ã€ å¸¸é—‡ãƒˆãƒ¯ / ãƒ›ãƒ­ãƒ©ã‚¤ãƒ– ã€‘',
    video_timestamp: "2025-11-02T13:36:47.756+00:00",
    total_yen: 1586584,
  },
  {
    video_id: "pmk8AL3P4m8",
    video_title:
      "ã€ Minecraft ã€‘1å‘¨å¹´ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã¨ãƒ›ãƒ­é¯–ã‚†ã£ãŸã‚Šè¦³å…‰ï¼ï¼ã€#ç¶ºã€…ç¾…ã€…ãƒ´ã‚£ãƒ´ã‚£ #hololiveDEV IS #FLOWGLOWã€‘",
    video_timestamp: "2025-11-08T10:55:27.171+00:00",
    total_yen: 894570,
  },
  {
    video_id: "qoNEDzHqAuU",
    video_title:
      "ã€æ–°è¡£è£…ãŠæŠ«éœ²ç›®ã€‘é‚ã«ã“ã®æ™‚ãŒæ¥ãŸâ€¦ãƒƒï¼ï¼ã€ç™¾é¬¼ã‚ã‚„ã‚/ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã€‘",
    video_timestamp: "2025-11-02T13:33:24.844+00:00",
    total_yen: 743730,
  },
  {
    video_id: "LmaO6MRTI-s",
    video_title:
      "ã€ ğŸŸ£é›‘è«‡ ã€‘äºŒãƒ¶æœˆãŠä¼‘ã¿é ‚ã„ã¦ã¾ã—ãŸğŸ˜¸ã€ çŒ«åˆãŠã‹ã‚†/ãƒ›ãƒ­ãƒ©ã‚¤ãƒ– ã€‘",
    video_timestamp: "2025-11-02T13:33:16.983+00:00",
    total_yen: 703944,
  },
  {
    video_id: "P1p8y5bF5Jw",
    video_title:
      "ã€CloverPitã€‘å‰å›å¼•ã„ãŸãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚¿ã‚¤ãƒ ã‚’ç¶™ç¶šã•ã›ã¦ï¼‘å‘¨å¹´ã¿ã‚“ãªã¨ã‚€ã‹ãˆã‚‹ãğŸ°ğŸ”¥ã€ãƒ›ãƒ­ãƒ©ã‚¤ãƒ– DEV IS éŸ¿å’²ãƒªã‚ªãƒŠã€‘",
    video_timestamp: "2025-11-08T11:32:35.114+00:00",
    total_yen: 674460,
  },
  {
    video_id: "-7bedX7qbhE",
    video_title:
      "ã€é›‘è«‡/chatã€‘é‚ã«1å‘¨å¹´ã§ã™ã£ã¦ã‚ˆï¼ï¼ï¼ä¸€ç·’ã«å‘ã‹ãˆã‚ˆï½ï½ã€#è¼ªå ‚åƒé€Ÿ / #hololivedev is  #FLOWGLOW ã€‘",
    video_timestamp: "2025-11-08T13:43:45.068+00:00",
    total_yen: 493673,
  },
  {
    video_id: "WfGS8QW-b40",
    video_title: "ã€3D LIVEã€‘LOG IN: GAME START #ROCKINBiboo",
    video_timestamp: "2025-11-02T13:35:47.56+00:00",
    total_yen: 490111,
  },
  {
    video_id: "QmpfwGfZEi4",
    video_title:
      "ã€CHATTINI DAY: 3D SPECIALã€‘IT'S CHATTINI APPRECIATION DAY!!! ğŸ©µ YAAAY! + ANNOUNCEMENT",
    video_timestamp: "2025-10-19T12:09:57+00:00",
    total_yen: 464894,
  },
  {
    video_id: "2PwZmb5inxY",
    video_title:
      "ã€ãƒãƒªã‚ªã‚«ãƒ¼ãƒˆ8DXã€‘1å‘¨å¹´ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³å‚åŠ å‹â•1ä½ç›®æŒ‡ã™â•âœ¨ã€æ°´å®®æ¢ï¼ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–DEV ISã€‘",
    video_timestamp: "2025-11-07T14:00:55.255+00:00",
    total_yen: 458058,
  },
  {
    video_id: "vl-RzysAA8Y",
    video_title:
      "ã€GIGI MURIN BDAY 2025ã€‘A PARTY AFTER A PARTY?!?! LIKE AN AFTERPARTY?!?",
    video_timestamp: "2025-10-21T21:03:08.67+00:00",
    total_yen: 383830,
  },
];

// const topChannels = await getTopChannels();
const topChannels = [
  { channel_id: "UC1uv2Oq6kNxgATlCiez59hw", total_yen: 1940125 },
  { channel_id: "UCGzTVXqMQHa4AgJVJIVvtDQ", total_yen: 1824191 },
  { channel_id: "UC9p_lqQ0FEDz327Vgf5JwqA", total_yen: 1567352 },
  { channel_id: "UC6eWCld0KwmyHFbAqK3V-Rw", total_yen: 1388284 },
  { channel_id: "UCL_qhgtOy0dy1Agp8vkySQg", total_yen: 1199658 },
  { channel_id: "UC9LSiN9hXI55svYEBrrK-tw", total_yen: 1058932 },
  { channel_id: "UC0TXe_LYZ4scaW2XMyi5_kw", total_yen: 1011374 },
  { channel_id: "UCqm3BQLlJfvkTsX_hvm0UmA", total_yen: 984356 },
  { channel_id: "UCDHABijvPBnJm7F-KlNME3w", total_yen: 964652 },
  { channel_id: "UCjk2nKmHzgH5Xy-C5qYRd5A", total_yen: 952520 },
];
// const recentVideos = await getRecentVideos();
const recentVideos = [
  {
    id: "3O4jBkgdWRQ",
    video_timestamp: "2025-12-30T21:14:15+00:00",
    channel_id: "UCO_aKKYxn4tvrqPjcTzZ6EQ",
    title: "ã€MINECRAFTã€‘ THE GRAND FINALE. THE WORLD TREE IS COMPLETE",
    total_yen: 0,
  },
  {
    id: "XNiRgmK54Hg",
    video_timestamp: "2025-12-29T23:24:06+00:00",
    channel_id: "UCO_aKKYxn4tvrqPjcTzZ6EQ",
    title: "Drawing Hololive Members From Memory with @GawrGura !",
    total_yen: 0,
  },
  {
    id: "uUwP1UYbYcU",
    video_timestamp: "2025-11-08T18:00:53.698+00:00",
    channel_id: "UCgnfPPb9JI3e9A4cXHnWbyg",
    title: "Cursed Auction: Curator Keeps Collecting Haunted Items!",
    total_yen: 153045,
  },
  {
    id: "LczdUQYusak",
    video_timestamp: "2025-11-08T15:06:50.249+00:00",
    channel_id: "UChgTyjG-pdNvxxhdsXfHQ5Q",
    title:
      "#2ã€Urban Myth Dissolution Centerã€‘THROWS TOMATOES AT YOUã€Pavolia Reine/hololiveIDã€‘",
    total_yen: 24748,
  },
  {
    id: "oea8O2eImgo",
    video_timestamp: "2025-11-08T13:52:30.254+00:00",
    channel_id: "UCFKOVgVbGmX65RxO3EtH3iw",
    title:
      "ã€é›‘è«‡ã€‘ã“ã®æ ãŒãã‚‹ãã‚‹ã ã£ãŸã‚‰è«¦ã‚ã‚‹ï¼ï¼ã€ é›ªèŠ±ãƒ©ãƒŸã‚£ /ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã€‘",
    total_yen: 45032,
  },
  {
    id: "-7bedX7qbhE",
    video_timestamp: "2025-11-08T13:43:45.068+00:00",
    channel_id: "UCKMWFR6lAstLa7Vbf5dH7ig",
    title:
      "ã€é›‘è«‡/chatã€‘é‚ã«1å‘¨å¹´ã§ã™ã£ã¦ã‚ˆï¼ï¼ï¼ä¸€ç·’ã«å‘ã‹ãˆã‚ˆï½ï½ã€#è¼ªå ‚åƒé€Ÿ / #hololivedev is  #FLOWGLOW ã€‘",
    total_yen: 493673,
  },
  {
    id: "QKjMh_IkEZY",
    video_timestamp: "2025-11-08T13:07:48.727+00:00",
    channel_id: "UCOyYb1c43VlX9rc_lT6NKQw",
    title: "Camper Van Java",
    total_yen: 1141,
  },
  {
    id: "IL5J_ExYeMw",
    video_timestamp: "2025-11-08T12:08:43.976+00:00",
    channel_id: "UCp6993wxpyDPHUpavwDFqgg",
    title: "ã€ç¥MVï¼‘ï¼ï¼ä¸‡å†ç”Ÿã€‘ã‚ã‚ŠãŒã¨ã†Pulseæ­Œæ ã€ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–/ã¨ãã®ãã‚‰ã€‘",
    total_yen: 26998,
  },
  {
    id: "P1p8y5bF5Jw",
    video_timestamp: "2025-11-08T11:32:35.114+00:00",
    channel_id: "UC9LSiN9hXI55svYEBrrK-tw",
    title:
      "ã€CloverPitã€‘å‰å›å¼•ã„ãŸãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚¿ã‚¤ãƒ ã‚’ç¶™ç¶šã•ã›ã¦ï¼‘å‘¨å¹´ã¿ã‚“ãªã¨ã‚€ã‹ãˆã‚‹ãğŸ°ğŸ”¥ã€ãƒ›ãƒ­ãƒ©ã‚¤ãƒ– DEV IS éŸ¿å’²ãƒªã‚ªãƒŠã€‘",
    total_yen: 674460,
  },
  {
    id: "pmk8AL3P4m8",
    video_timestamp: "2025-11-08T10:55:27.171+00:00",
    channel_id: "UCGzTVXqMQHa4AgJVJIVvtDQ",
    title:
      "ã€ Minecraft ã€‘1å‘¨å¹´ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã¨ãƒ›ãƒ­é¯–ã‚†ã£ãŸã‚Šè¦³å…‰ï¼ï¼ã€#ç¶ºã€…ç¾…ã€…ãƒ´ã‚£ãƒ´ã‚£ #hololiveDEV IS #FLOWGLOWã€‘",
    total_yen: 894570,
  },
];

// const superchatCount = await getSuperchatCount()
const superchatCount = 22942;
// const videoCount = await getUniqueVideoCount()
const videoCount = 793;
---

<Layout title="holoboard">
  <div class="space-y-4">
    <SummaryTable
      data={[
        {
          text: formatNumberCompact(
            plotlyYData.reduce(
              (accumulator, currentValue) => accumulator + currentValue,
              0
            )
          ),
          label: "Total",
        },
        { text: videoCount.toLocaleString(), label: "Streams" },
        { text: superchatCount.toLocaleString(), label: "Superchats" },
      ]}
    />
    <div class="flex flex-wrap lg:flex-nowrap gap-4 justify-center items-center">
      <div class="w-full lg:w-[70%] h-80 ">
        <div id="dailyYenChart"></div>
      </div>
      <div class="w-full lg:w-[30%] flex flex-col gap-4">
        <Card>
          <TopDonors
            data={topChannels.map((obj) => ({
              key: channelIdToNameMap[obj.channel_id],
              yen: obj.total_yen,
              url: `/channel/${obj.channel_id}`,
            }))}
            title="Top Channels"
          />
        </Card>
      </div>
    </div>
    <div class="flex flex-wrap lg:flex-nowrap gap-4">
      <div class="w-full lg:w-[70%]">
        <Card>
          <TabVideo
            topVideos={topVideos}
            recentVideos={recentVideos.map((obj) => ({
              video_id: obj.id,
              video_title: obj.title,
              video_timestamp: obj.video_timestamp,
              total_yen: obj.total_yen,
            }))}
            loading="lazy"
          />
        </Card>
      </div>
      <div class="w-full lg:w-[30%] flex flex-col gap-4">
        <Card>
          <TopDonors
            data={yenByName.map((obj) => ({
              key: obj.chat_name,
              yen: obj.total_yen,
            }))}
            title="Top Donors"
          />
        </Card>
      </div>
    </div>
  </div>
  <script src="https://cdn.plot.ly/plotly-3.2.0.min.js" charset="utf-8"
  ></script>

  <script is:inline define:vars={{ plotlyXData, plotlyYData }}>
    window.addEventListener("load", function () {
      const trace1 = {
        x: plotlyXData,
        y: plotlyYData,
        type: "bar",
        mode: "lines",
        line: {
          color: "#3380FF",
          shape: "linear",
        },
        fill: "tozeroy",
        fillcolor: "rgba(51, 128, 255, 0.2)",
        marker: {
          color: "#3380FF",
          size: 3,
        },
      };

      const layout = {
        autosize: true,
        height: 320,
        margin: { t: 20, r: 20, b: 20, l: 60 },
        showlegend: false,
        paper_bgcolor: "transparent",
        plot_bgcolor: "transparent",
        yaxis: {
          rangemode: "nonnegative",
          tickfont: {
            color: "#AAAAAA",
          },
          tickprefix: "Â¥",
          showgrid: false,
          zeroline: false,
          tickformat: ".2s",
        },
        xaxis: {
          type: "date",
          tickfont: {
            color: "#AAAAAA",
          },
          nticks: 4,
          showgrid: false,
          zeroline: false,
          tickformat: "%Y-%m-%d",
        },
        hoverlabel: {
          bgcolor: "#424549",
          font: {
            color: "#E0E0E0",
          },
          bordercolor: "#818385",
        },
      };

      const config = {
        responsive: true,
        displayModeBar: false,
      };

      Plotly.newPlot("dailyYenChart", [trace1], layout, config);
    });
  </script>
</Layout>
